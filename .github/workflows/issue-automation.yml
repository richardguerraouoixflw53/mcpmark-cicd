name: Issue Management Automation

on:
  issues:
    types: [opened, labeled]

jobs:
  issue-triage:
    runs-on: ubuntu-latest
    steps:
      - name: Triage Issue
        uses: actions/github-script@v6
        with:
          script: |
            const issue = context.payload.issue;
            const title = issue.title.toLowerCase();
            const body = issue.body ? issue.body.toLowerCase() : '';
            const labels = issue.labels.map(l => l.name);

            // Add initial needs-triage label
            if (!labels.includes('needs-triage')) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['needs-triage']
              });
            }

            // Add category labels based on title
            const categoryLabels = [];
            if (title.includes('bug')) categoryLabels.push('bug');
            if (title.includes('epic')) categoryLabels.push('epic');
            if (title.includes('maintenance')) categoryLabels.push('maintenance');

            if (categoryLabels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: categoryLabels
              });
            }

            // Add priority labels based on title/body
            const priorityKeywords = [
              { keywords: ['critical', 'urgent', 'production', 'outage'], label: 'priority-critical' },
              { keywords: ['important', 'high', 'blocking'], label: 'priority-high' },
              { keywords: ['low', 'nice-to-have', 'minor'], label: 'priority-low' },
              { keywords: ['medium', 'normal'], label: 'priority-medium' }
            ];

            let priorityLabel = 'priority-medium'; // default
            for (const { keywords, label } of priorityKeywords) {
              if (keywords.some(k => title.includes(k) || body.includes(k))) {
                priorityLabel = label;
                break;
              }
            }

            if (!labels.includes(priorityLabel)) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: [priorityLabel]
              });
            }